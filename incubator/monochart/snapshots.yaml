job:
  snapshots:
    enabled: true
    image:
      repository: mesosphere/aws-cli
      tag: 1.14.5
      pullPolicy: IfNotPresent
    annotations:
      "helm.sh/hook": "pre-install"
    restartPolicy: Never
    pod:
      commands:
        - |
          {{- range $snapshot := .Values.persistence.snapshots }}
          aws ec2 create-volume --availability-zone=${REGION} --snapshot-id {{ $snapshot.id }} --region=${REGION} --volume-type gp2 --tag-specifications 'ResourceType=volume,Tags=[{Key=KubernetesCluster,Value=${CLUSTER_NAME}}]'
          {
              "AvailabilityZone": "us-west-2a",
              "CreateTime": "2018-05-20T12:05:23.000Z",
              "Encrypted": false,
              "Size": 1,
              "SnapshotId": "snap-0cb9ddd144d8c047b",
              "State": "creating",
              "VolumeId": "vol-0e65bfd7da63a06b3",
              "Iops": 100,
              "Tags": [
                  {
                      "Key": "KubernetesCluster",
                      "Value": "${CLUSTER_NAME}"
                  }
              ],
              "VolumeType": "gp2"
          }
          {{- end }}


persistence:
  snapshots:
    - id: "some-id"

secrets:
  aws:
    enabled: true
    env:
      REGION: us-west-2a
      CLUSTER_NAME: test.k8s.local
